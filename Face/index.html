<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>JSSample</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
</head>
<body>
  <canvas id="myCanvas" width="1500" height="700"></canvas>
  <p id="people"></p>
  <style>
    .thumb {
      height: 75px;
      border: 1px solid #000;
      margin: 10px 5px 0 0;
    }
  </style>

  <input type="file" id="files" name="files[]" multiple />
  <output id="list"></output>

  <script>

  PEOPLE = [
		{
			"desc":"Elab Tartus",
			"fbid":"kjbalder",
			"name":"Karl Johannes Balder",
			"personId":"e9fa8adf-e3d5-4be3-9662-f3d66412676a"
		},
		{
			"desc":"Nuusutab tihti lilli, mis võivad tal olla käes",
			"fbid":"lauralenbaum",
			"name":"Laura Lenbaum",
			"personId":"5982fed2-d57d-43d8-8469-f6c5a194c176"
		},
		{
			"desc":"Kannab kampsuneid",
			"fbid":"radne11",
			"name":"Radne Kaal",
			"personId":"4237345d-71e3-4428-bdd3-fc5eb244e802"
		},
		{
			"desc":"Käib gümnaasiumis",
			"fbid":"kristjan.variksoo",
			"name":"Kristjan Variksoo",
			"personId":"7adb44aa-0474-4c98-b4e3-b4a69d2d65d8"
		}
	];

  makeblob = function (dataURL) {
      var BASE64_MARKER = ';base64,';
      if (dataURL.indexOf(BASE64_MARKER) == -1) {
          var parts = dataURL.split(',');
          var contentType = parts[0].split(':')[1];
          var raw = decodeURIComponent(parts[1]);
          return new Blob([raw], { type: contentType });
      }
      var parts = dataURL.split(BASE64_MARKER);
      var contentType = parts[0].split(':')[1];
      var raw = window.atob(parts[1]);
      var rawLength = raw.length;

      var uInt8Array = new Uint8Array(rawLength);

      for (var i = 0; i < rawLength; ++i) {
          uInt8Array[i] = raw.charCodeAt(i);
      }

      return new Blob([uInt8Array], { type: contentType });
  }

    var IMAGE;
    var FACES;

    function handleFileSelect(evt) {
      document.getElementById("people").innerHTML = "";
      var files = evt.target.files; // FileList object

      // Loop through the FileList and render image files as thumbnails.
      for (var i = 0, f; f = files[i]; i++) {

        // Only process image files.
        if (!f.type.match('image.*')) {
          continue;
        }

        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(theFile) {
          return function(e) {



            console.log(e.target.result);
            IMAGE = e.target.result;


            var c=document.getElementById("myCanvas");
            var ctx=c.getContext("2d");
            var img = new Image;
            img.src = IMAGE + "";
            console.log(img);
            ctx.drawImage(img,10,10);
            var canvas = document.getElementById('myCanvas');
            var context = canvas.getContext('2d');




            document.getElementById('files').addEventListener('change', handleFileSelect, false);

            var params = {"returnFaceId":true, "returnFaceLandmarks":false};
            $.ajax({
                url: "https://westcentralus.api.cognitive.microsoft.com/face/v1.0/detect?" + $.param(params),
                beforeSend: function(xhrObj){
                    // Request headers
                    xhrObj.setRequestHeader("Content-Type","application/octet-stream");

                    // NOTE: Replace the "Ocp-Apim-Subscription-Key" value with a valid subscription key.
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","26b9b465ce4d4aab93fda70cd5b033b6");
                },
                type: "POST",
                processData:false,
                // Request body
                data: makeblob(IMAGE)

            })
            .done(function(data) {
              console.log("DETECT IS DONE! GREIT SUKSEESSS!");
              console.log(data);

              FACES = data;

              faceIds = [];

              data.forEach(function (element) {
                faceIds.push(element["faceId"]);

              }
            );

              console.log("foreach litib");
              console.log(faceIds);

              var params2 = {};

              $.ajax({
                  url: "https://westcentralus.api.cognitive.microsoft.com/face/v1.0/identify?" + $.param(params2),
                  beforeSend: function(xhrObj){
                      // Request headers
                      xhrObj.setRequestHeader("Content-Type","application/json");

                      // NOTE: Replace the "Ocp-Apim-Subscription-Key" value with a valid subscription key.
                      xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","26b9b465ce4d4aab93fda70cd5b033b6");
                  },
                  type: "POST",
                  // Request body
                  data: '{"personGroupId": "enginaator","faceIds": ' + JSON.stringify(faceIds) + ',"maxNumOfCandidatesReturned": 1, "confidenceThreshold":0.1}'

              })
              .done(function(data) {
                FACES.forEach(function (face) {
                  data.forEach(function (dat) {
                    if (face["faceId"] == dat["faceId"]) {
                      face["candidates"] = dat["candidates"];
                    }
                  });
                });

                console.log("WE ARE DONE!");
                console.log(FACES);

                KnownPeople = 0;

                FACES.forEach(function (face) {

                    rect = face["faceRectangle"];
                    context.beginPath();
                    context.rect(rect["left"], rect["top"], rect["width"], rect["height"]);

                    context.lineWidth = 7;
                    if (face["candidates"].length != 0) {
                      //On Kristjan
                      context.strokeStyle = 'green';
                      PEOPLE.forEach(function (person) {

                        if (face["candidates"][0]["personId"] == person["personId"]) {
                          person["OnImgIndex"] = KnownPeople;

                          context.font = "32pt Calibri";
                          context.strokeStyle = 'white';
                          context.fillText("" + KnownPeople, rect["left"] + (rect["width"] / 2), rect["top"] + (rect["height"]/2));

                          document.getElementById("people").innerHTML = document.getElementById("people").innerHTML + person["OnImgIndex"] + "  -  " + person["name"] + "<br>";

                          KnownPeople += 1;
                        }
                      });
                    } else {
                      //Ei ole Kristjan
                      context.strokeStyle = 'red';
                    }
                    context.stroke();



                //  ______ _            _ _   _
                // |  ____(_)          (_) | | |
                // | |__   ___  __      _| |_| |
                // |  __| | \ \/ /     | | __| |
                // | |    | |>  <      | | |_|_|
                // |_|    |_/_/\_\     |_|\__(_)
                // Praegu oletame, et on üks kandidaat, tulevikus on mitu.


                  //if (face["candidates"][0])
                  /**/
                });
                console.log("PEOPLE");
                console.log(PEOPLE);


              })
              .fail(function() {
                  alert("error");
              });
            })
            .fail(function() {
                alert("error");
            });

          };
        })(f);



        // Read in the image file as a data URL.
        reader.readAsDataURL(f);
      }
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>

<script type="text/javascript">

$(function() {


});
</script>
</body>
</html>
